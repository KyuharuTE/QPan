<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>QPan</title>
		<style>
			*,
			*::before,
			*::after {
				box-sizing: border-box;
			}
			body {
				font-family: Arial, sans-serif;
				background: #fafafa;
				margin: 0;
				padding: 0;
			}
			.site-header {
				background: #ffffff;
				color: #333333;
				padding: 12px 20px;
				border-bottom: 1px solid #ddd;
				text-align: center;
				max-width: 800px;
				margin: 20px auto 10px;
				border-radius: 6px;
			}
			.site-header h1 {
				margin: 0;
				font-size: 20px;
				font-weight: 600;
			}
			.file-list-container {
				max-width: 800px;
				margin: 0 auto;
				background: #fff;
				border: 1px solid #ddd;
				border-radius: 6px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.search-bar {
				padding: 10px;
				border-bottom: 1px solid #eee;
			}
			.search-bar input {
				width: 100%;
				padding: 8px;
				border: 1px solid #ccc;
				border-radius: 4px;
				font-size: 14px;
			}
			.file-list {
				list-style: none;
				margin: 0;
				padding: 0;
			}
			.file-list .header,
			.file-list .item {
				display: flex;
				align-items: center;
				padding: 12px 16px;
			}
			.file-list .header {
				background: #f5f5f5;
				font-weight: bold;
				border-bottom: 1px solid #ddd;
				cursor: pointer;
			}
			.file-list .item {
				cursor: pointer;
			}
			.file-list .item .icon {
				flex: 0 0 auto;
				margin-right: 8px;
				text-align: center;
			}
			.file-list .header span,
			.file-list .item span:not(.icon) {
				flex: 1;
				text-align: left;
			}
			.file-list .header span.size,
			.file-list .item span.size,
			.file-list .header span.date,
			.file-list .item span.date {
				text-align: right;
				flex: 0 0 100px;
			}
			.file-list .item:hover {
				background: #fbfbfb;
			}
			.site-footer {
				max-width: 800px;
				margin: 10px auto 20px;
				padding: 10px 20px;
				text-align: center;
				color: #666666;
				font-size: 14px;
			}
			#announceOverlay {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.5);
				display: none;
				align-items: center;
				justify-content: center;
			}
			#announceModal {
				background: #fff;
				padding: 20px;
				border-radius: 6px;
				max-width: 500px;
				width: 90%;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
				position: relative;
			}
			#announceModal .close-btn {
				position: absolute;
				top: 10px;
				right: 10px;
				border: none;
				background: transparent;
				font-size: 18px;
				cursor: pointer;
			}
			.file-list .item span.name {
				flex: 1;
				min-width: 0;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			.file-list .header span.name {
				min-width: 0;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			.file-list .item span.size,
			.file-list .item span.date,
			.file-list .header span.size,
			.file-list .header span.date {
				min-width: 0;
				flex: 0 0 80px;
			}
			a {
				color: #007bff;
				text-decoration: none;
				transition: color 0.2s ease-in-out,
					background-color 0.2s ease-in-out;
			}
			a:hover {
				color: #0056b3;
				text-decoration: underline;
			}
			a.button {
				display: inline-block;
				background-color: #007bff;
				color: #fff;
				padding: 6px 12px;
				border-radius: 4px;
				text-decoration: none;
			}
			a.button:hover {
				background-color: #0056b3;
			}
			a.disabled,
			a[disabled] {
				pointer-events: none;
				color: #999;
				opacity: 0.6;
			}

			@media (max-width: 600px) {
				.site-header,
				.file-list-container,
				.site-footer {
					margin: 10px;
					border-radius: 6px;
				}
				.search-bar input {
					font-size: 12px;
					padding: 6px;
				}
				.file-list .item,
				.file-list .header {
					padding: 8px 12px;
				}
				.file-list .item span.size,
				.file-list .item span.date,
				.file-list .header span.size,
				.file-list .header span.date {
					flex: 0 0 60px;
				}
			}
		</style>
	</head>
	<body>
		<div class="site-header">
			<h1>QPan</h1>
		</div>
		<div class="file-list-container">
			<div class="search-bar">
				<input type="text" id="searchInput" placeholder="ÊêúÁ¥¢Êñá‰ª∂..." />
			</div>
			<ul class="file-list" id="fileList">
				<li class="header">
					<span class="name" data-sort="name">ÂêçÁß∞</span>
					<span class="size" data-sort="size">Â§ßÂ∞è</span>
					<!-- <span class="date" data-sort="date">‰øÆÊîπÊó•Êúü</span> -->
				</li>
			</ul>
		</div>
		<div id="announceOverlay">
			<div id="announceModal">
				<button class="close-btn" id="announceClose">√ó</button>
				<div id="announceContent">
					<p>
						ÂºÄÊ∫êÂú∞ÂùÄ:
						<a href="https://github.com/KyuharuTE/qpan"
							>https://github.com/KyuharuTE/qpan</a
						>
					</p>
				</div>
			</div>
		</div>
		<div class="site-footer">
			<p>¬© 2025 <a href="https://github.com/KyuharuTE">Nacho</a></p>
		</div>
		<script>
			const baseUrl = "";

			const fileTree = { root: [] };
			const folderParent = {};
			let currentFolderId = "root";
			const fileList = document.getElementById("fileList");
			const searchInput = document.getElementById("searchInput");
			const announceOverlay = document.getElementById("announceOverlay");
			const announceContent = document.getElementById("announceContent");
			const announceClose = document.getElementById("announceClose");

			function showAnnouncement() {
				announceOverlay.style.display = "flex";
			}
			announceClose.addEventListener("click", () => {
				announceOverlay.style.display = "none";
			});

			function handleFileClick(fileId, file_name) {
				fetch(baseUrl + "/get_file_url?file_id=" + fileId).then(
					(res) => {
						res.json().then((data) => {
							if (data.code == 200) {
								const a = document.createElement("a");
								a.href = data.data.url + file_name;
								document.body.appendChild(a);
								a.click();
								document.body.removeChild(a);
							}
						});
					}
				);
			}
			fileList.addEventListener("click", (e) => {
				const li = e.target.closest("li.item");
				if (!li) return;
				if (li.dataset.back) renderList(li.dataset.back);
				else if (li.dataset.type === "folder") {
					const folder_id = li.dataset.id;

					fetch(
						baseUrl + "/get_dir?folder_id=" + folder_id.slice(1)
					).then((res) => {
						res.json().then((data) => {
							if (data.code == 200) {
								const file_array = data.data.files;
								fileTree[folder_id].length = 0;
								file_array.forEach((file) => {
									addFileItem(
										file.file_name,
										formatBytes(file.file_size),
										formatTimestamp(file.modify_time),
										"üìÑ",
										folder_id,
										file.file_id
									);
								});

								renderList(folder_id);
							}
						});
					});
				} else if (li.dataset.type === "file")
					handleFileClick(li.dataset.id, li.dataset.name);
			});

			function renderList(folderId) {
				currentFolderId = folderId;
				searchInput.value = "";
				fileList
					.querySelectorAll(":scope > .item")
					.forEach((el) => el.remove());
				if (folderId !== "root") {
					const backLi = document.createElement("li");
					backLi.className = "item back";
					backLi.dataset.back = folderParent[folderId] || "root";
					backLi.innerHTML =
						'<span class="icon">‚óÄÔ∏è</span><span class="name">ËøîÂõû‰∏äÁ∫ß</span><span class="size"></span><span class="date"></span>';
					fileList.appendChild(backLi);
				}
				fileTree[folderId].forEach((node) => {
					const li = document.createElement("li");
					li.className = "item";
					li.dataset.type = node.type;
					li.dataset.id = node.id;
					li.dataset.name = node.name;
					if (node.type === "file") {
						li.dataset.size = node.size;
						li.dataset.date = node.date;
					}
					li.innerHTML = `
          <span class="icon">${node.icon}</span>
          <span class="name">${node.name}</span>
          <span class="size">${node.type === "file" ? node.size : ""}</span>
        `;

					// <span class="date">${node.type === "file" ? node.date : ""}</span>
					fileList.appendChild(li);
				});
				bindSort();
				sortFiles("name");
			}

			searchInput.addEventListener("input", function () {
				const filter = this.value.trim().toLowerCase();
				if (!filter) return renderList(currentFolderId);
				fileList
					.querySelectorAll(":scope > .item")
					.forEach((el) => el.remove());
				const results = [];
				(function traverse(id) {
					fileTree[id].forEach((n) => {
						if (
							n.type === "file" &&
							n.name.toLowerCase().includes(filter)
						)
							results.push(n);
						if (n.type === "folder") traverse(n.id);
					});
				})("root");
				results.forEach((n) => {
					const li = document.createElement("li");
					li.className = "item";
					li.dataset.type = "file";
					li.dataset.id = n.id;
					li.dataset.name = n.name;
					li.dataset.size = n.size;
					li.dataset.date = n.date;
					li.innerHTML = `
          <span class="icon">${n.icon}</span>
          <span class="name">${n.name}</span>
          <span class="size">${n.size}</span>
        `;
					// <span class="date">${n.date}</span>
					fileList.appendChild(li);
				});
				bindSort();
				sortFiles("name");
			});

			function addFolder(name, icon = "üìÅ", folderId, parentId = "root") {
				if (!fileTree[parentId]) fileTree[parentId] = [];
				fileTree[parentId].push({
					type: "folder",
					id: folderId,
					name,
					icon,
				});
				fileTree[folderId] = [];
				folderParent[folderId] = parentId;
				return folderId;
			}

			function addFileItem(
				name,
				size,
				date,
				icon = "üìÑ",
				folderId = "root",
				fileId = ""
			) {
				const parent = fileTree[folderId] ? folderId : "root";
				fileTree[parent].push({
					type: "file",
					id: fileId,
					name,
					size,
					date,
					icon,
				});
				if (parent === currentFolderId) renderList(currentFolderId);
				return fileId;
			}

			function bindSort() {
				document
					.querySelectorAll(".file-list .header span")
					.forEach(
						(h) => (h.onclick = () => sortFiles(h.dataset.sort))
					);
			}

			function sortFiles(key) {
				const items = Array.from(
					fileList.querySelectorAll(":scope > li.item:not(.back)")
				);
				const folders = items.filter(
					(i) => i.dataset.type === "folder"
				);
				const files = items.filter((i) => i.dataset.type === "file");
				folders.sort((a, b) =>
					a.dataset.name.localeCompare(b.dataset.name, undefined, {
						sensitivity: "base",
					})
				);
				if (key === "name")
					files.sort((a, b) =>
						a.dataset.name.localeCompare(
							b.dataset.name,
							undefined,
							{ sensitivity: "base" }
						)
					);
				else if (key === "size")
					files.sort(
						(a, b) =>
							parseFloat(b.dataset.size) -
							parseFloat(a.dataset.size)
					);
				else if (key === "date")
					files.sort(
						(a, b) =>
							new Date(b.dataset.date) - new Date(a.dataset.date)
					);
				folders.concat(files).forEach((i) => fileList.appendChild(i));
			}

			function formatBytes(bytes, decimals = 2) {
				if (bytes === 0) return "0 B";
				const k = 1024;
				const sizes = ["B", "KB", "MB", "GB", "TB"];
				const i = Math.floor(Math.log(bytes) / Math.log(k));
				const value = parseFloat(
					(bytes / Math.pow(k, i)).toFixed(decimals)
				);
				return `${value} ${sizes[i]}`;
			}

			function formatTimestamp(timestamp) {
				const date = new Date(timestamp);
				const year = date.getFullYear();
				const month = String(date.getMonth() + 1).padStart(2, "0");
				const day = String(date.getDate()).padStart(2, "0");
				const hours = String(date.getHours()).padStart(2, "0");
				const minutes = String(date.getMinutes()).padStart(2, "0");
				const seconds = String(date.getSeconds()).padStart(2, "0");

				return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
			}

			fetch(baseUrl + "/get_root_dir").then((res) => {
				res.json().then((data) => {
					if (data.code == 200) {
						console.log(data.data);

						const folder_array = data.data.folders;
						folder_array.forEach((folder) => {
							addFolder(
								folder.folder_name,
								"üìÅ",
								folder.folder_id
							);
						});

						const file_array = data.data.files;
						file_array.forEach((file) => {
							addFileItem(
								file.file_name,
								formatBytes(file.file_size),
								formatTimestamp(file.modify_time),
								"üìÑ",
								"root",
								file.file_id
							);
						});

						renderList("root");
					}
				});
			});
			showAnnouncement();
		</script>
	</body>
</html>
